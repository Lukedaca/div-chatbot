<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Asistent | DIV.cz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007aff;
            --primary-dark: #0051d5;
            --secondary: #5856d6;
            --text-dark: #0a0a0a;
            --text-light: #8e8e93;
            --bg-light: #f5f5f7;
            --bg-ultra-light: #fafafa;
            --white: #ffffff;
            --border-color: rgba(0, 0, 0, 0.08);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px rgba(0, 122, 255, 0.12);
            --shadow-lg: 0 20px 60px rgba(0, 122, 255, 0.2);
            --shadow-hover: 0 25px 70px rgba(0, 122, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 30%, rgba(0, 122, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(88, 86, 214, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 45, 85, 0.08) 0%, transparent 50%);
            z-index: 0;
            animation: gradientFloat 15s ease-in-out infinite;
        }

        @keyframes gradientFloat {
            0%, 100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1) rotate(5deg);
            }
        }

        /* Animated particles background */
        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(0, 122, 255, 0.3), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(88, 86, 214, 0.3), transparent),
                radial-gradient(1px 1px at 80% 10%, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200% 200%;
            animation: particleFloat 20s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes particleFloat {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
        }

        /* CHAT WIDGET STYLES */
        .chat-widget {
            position: relative;
            width: 100%;
            height: 100vh;
            max-width: 360px;
            max-height: 550px;
            z-index: 1000;
            font-family: 'Inter', sans-serif;
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chat-container {
            position: relative;
            bottom: auto;
            right: auto;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(60px) saturate(200%);
            border-radius: 28px;
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 30px 80px rgba(0, 122, 255, 0.3),
                0 0 100px rgba(88, 86, 214, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 28px;
            padding: 1px;
            background: linear-gradient(135deg,
                rgba(0, 122, 255, 0.5) 0%,
                rgba(88, 86, 214, 0.5) 50%,
                rgba(255, 45, 85, 0.3) 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }

        .chat-container:hover::before {
            opacity: 1;
        }

        .chat-container:hover {
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.2) inset,
                0 40px 100px rgba(0, 122, 255, 0.5),
                0 0 150px rgba(88, 86, 214, 0.3),
                0 0 50px rgba(0, 122, 255, 0.4);
            transform: translateY(-2px);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .chat-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.15), transparent 60%);
            pointer-events: none;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.2),
                0 0 20px rgba(255, 255, 255, 0.3) inset;
            z-index: 1;
            position: relative;
            animation: avatarPulse 3s ease-in-out infinite;
        }

        @keyframes avatarPulse {
            0%, 100% {
                box-shadow:
                    0 4px 12px rgba(0, 0, 0, 0.2),
                    0 0 20px rgba(255, 255, 255, 0.3) inset;
            }
            50% {
                box-shadow:
                    0 4px 16px rgba(0, 0, 0, 0.3),
                    0 0 30px rgba(255, 255, 255, 0.5) inset;
            }
        }

        .chat-header-info {
            z-index: 1;
        }

        .chat-header-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .chat-header-info p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin: 0;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background:
                linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%),
                radial-gradient(circle at 10% 20%, rgba(0, 122, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(88, 86, 214, 0.08) 0%, transparent 50%);
            position: relative;
        }

        .chat-messages::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 122, 255, 0.2);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 122, 255, 0.3);
        }

        .message {
            margin-bottom: 1.25rem;
            display: flex;
            flex-direction: column;
            animation: messageSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-items: flex-end;
        }

        .bot-message {
            align-items: flex-start;
        }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 18px;
            max-width: 85%;
            line-height: 1.5;
            font-size: 0.95rem;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: relative;
            transition: all 0.2s ease;
        }

        .user-message .message-bubble {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary) 100%);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow:
                0 4px 20px rgba(0, 122, 255, 0.4),
                0 0 30px rgba(0, 122, 255, 0.2),
                0 1px 0 rgba(255, 255, 255, 0.3) inset;
            position: relative;
            overflow: hidden;
        }

        .user-message .message-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .user-message .message-bubble:hover::before {
            left: 100%;
        }

        .user-message .message-bubble:hover {
            box-shadow:
                0 8px 30px rgba(0, 122, 255, 0.5),
                0 0 50px rgba(0, 122, 255, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.4) inset;
            transform: translateY(-2px) scale(1.02);
        }

        .bot-message .message-bubble {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom-left-radius: 6px;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.1),
                0 0 20px rgba(0, 122, 255, 0.05);
            position: relative;
        }

        .bot-message .message-bubble:hover {
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.15),
                0 0 40px rgba(0, 122, 255, 0.15);
            border-color: rgba(0, 122, 255, 0.4);
            transform: translateX(4px);
        }

        .bot-message .message-bubble a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .bot-message .message-bubble a:hover {
            text-decoration: underline;
        }

        .learned-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.4rem 0.75rem;
            border-radius: 12px;
            margin-top: 0.75rem;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .suggestions {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .suggestion-chip {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            color: var(--white);
            padding: 0.65rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                0 0 20px rgba(0, 122, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        .suggestion-chip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .suggestion-chip:hover::before {
            width: 300px;
            height: 300px;
        }

        .suggestion-chip:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary) 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow:
                0 6px 24px rgba(0, 122, 255, 0.5),
                0 0 40px rgba(0, 122, 255, 0.3);
            transform: translateY(-4px) scale(1.05);
        }

        .suggestion-chip:active {
            transform: translateY(-2px) scale(1.02);
        }

        .chat-input-container {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .chat-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            font-size: 0.95rem;
            outline: none;
            resize: none;
            max-height: 120px;
            font-family: 'Inter', sans-serif;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: var(--white);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                0 0 20px rgba(0, 122, 255, 0.05) inset;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
            box-shadow:
                0 0 0 4px rgba(0, 122, 255, 0.2),
                0 4px 20px rgba(0, 122, 255, 0.3),
                0 0 40px rgba(0, 122, 255, 0.15) inset;
            background: rgba(255, 255, 255, 0.08);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            opacity: 1;
        }

        .chat-controls {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                0 0 20px rgba(0, 122, 255, 0.05);
        }

        .control-btn:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary) 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow:
                0 4px 16px rgba(0, 122, 255, 0.4),
                0 0 30px rgba(0, 122, 255, 0.3);
            transform: translateY(-2px) rotate(5deg);
        }

        .control-btn:active {
            transform: translateY(0) rotate(0deg);
        }

        .control-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary) 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow:
                0 4px 16px rgba(0, 122, 255, 0.4),
                0 0 30px rgba(0, 122, 255, 0.3);
            animation: activeButtonPulse 2s ease-in-out infinite;
        }

        @keyframes activeButtonPulse {
            0%, 100% {
                box-shadow:
                    0 4px 16px rgba(0, 122, 255, 0.4),
                    0 0 30px rgba(0, 122, 255, 0.3);
            }
            50% {
                box-shadow:
                    0 4px 20px rgba(0, 122, 255, 0.6),
                    0 0 50px rgba(0, 122, 255, 0.5);
            }
        }

        .chat-send-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 14px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            flex-shrink: 0;
            box-shadow:
                0 4px 20px rgba(0, 122, 255, 0.5),
                0 0 40px rgba(0, 122, 255, 0.3),
                0 2px 0 rgba(255, 255, 255, 0.3) inset;
            position: relative;
            overflow: hidden;
        }

        .chat-send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .chat-send-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .chat-send-btn:hover {
            box-shadow:
                0 8px 30px rgba(0, 122, 255, 0.7),
                0 0 60px rgba(0, 122, 255, 0.5),
                0 2px 0 rgba(255, 255, 255, 0.4) inset;
            transform: translateY(-3px) scale(1.1) rotate(5deg);
        }

        .chat-send-btn:active {
            transform: translateY(-1px) scale(1.05) rotate(0deg);
        }

        .typing-indicator {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 80%;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.1),
                0 0 30px rgba(0, 122, 255, 0.1);
            animation: typingGlow 2s ease-in-out infinite;
        }

        @keyframes typingGlow {
            0%, 100% {
                box-shadow:
                    0 4px 16px rgba(0, 0, 0, 0.1),
                    0 0 30px rgba(0, 122, 255, 0.1);
            }
            50% {
                box-shadow:
                    0 4px 20px rgba(0, 0, 0, 0.15),
                    0 0 50px rgba(0, 122, 255, 0.3);
            }
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '...';
            animation: typingDots 1.5s infinite;
        }

        @keyframes typingDots {
            0%, 33% { content: '.'; }
            34%, 66% { content: '..'; }
            67%, 100% { content: '...'; }
        }

        .progress-bar {
            width: 100%;
            height: 3px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary) 100%);
            width: 0%;
            transition: width 0.8s ease;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
        }
    </style>
</head>
<body>

    <div class="chat-widget">
        <div class="chat-container active" id="chat-container">
            <div class="chat-header">
                <div class="chat-avatar">üé¨</div>
                <div class="chat-header-info">
                    <h3>AI Asistent</h3>
                    <p>DIV.cz ‚Ä¢ Online</p>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <!-- √övodn√≠ zpr√°va -->
                <div class="message bot-message">
                    <div class="message-bubble">
                        Ahoj! Jsem AI asistent webu DIV.cz. üé¨ M≈Ø≈æete se mƒõ pt√°t na filmy, seri√°ly, knihy, hry, recenze nebo cokoliv jin√©ho z oblasti z√°bavy. R√°d v√°m pomohu! A ano - uƒç√≠m se z ka≈æd√© konverzace! üß†
                    </div>
                </div>
            </div>

            <div class="suggestions" id="suggestions">
                <button class="suggestion-chip" onclick="useSuggestion(this)">Doporuƒç film</button>
                <button class="suggestion-chip" onclick="useSuggestion(this)">Nov√© seri√°ly</button>
                <button class="suggestion-chip" onclick="useSuggestion(this)">Hern√≠ novinky</button>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea
                        class="chat-input"
                        id="user-input"
                        placeholder="Napi≈°te sv≈Øj dotaz..."
                        rows="1"
                    ></textarea>
                    <div class="chat-controls">
                        <button class="control-btn" id="voice-btn" title="Hlasov√© ovl√°d√°n√≠">üé§</button>
                        <button class="control-btn" id="image-btn" title="Nahr√°t obr√°zek">üñºÔ∏è</button>
                        <input type="file" id="image-upload" accept="image/*" style="display: none;">
                        <button class="control-btn" id="speaker-btn" title="P≈ôeƒç√≠st odpovƒõƒè nahlas">üîä</button>
                    </div>
                </div>
                <button class="chat-send-btn" id="send-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // CHATBOT CONFIGURATION - ZDE NASTAVTE SV≈ÆJ API KL√çƒå
        const CONFIG = {
            API_KEY: "", // üëà ZDE VLO≈ΩTE SV≈ÆJ ANTHROPIC API KL√çƒå
            MODEL: "claude-3-haiku-20240307",
            API_URL: "https://api.anthropic.com/v1/messages",
            MAX_TOKENS: 2048,
            TIMEOUT: 45000
        };

        // CHAT WIDGET FUNCTIONALITY
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const suggestionsContainer = document.getElementById('suggestions');
        const voiceBtn = document.getElementById('voice-btn');
        const imageBtn = document.getElementById('image-btn');
        const imageUpload = document.getElementById('image-upload');
        const speakerBtn = document.getElementById('speaker-btn');

        let conversation = [];
        let uploadedImage = null;
        let isRecording = false;
        let recognition = null;
        let lastBotMessage = "";
        let inactivityTimer;

        // KNOWLEDGE BASE FOR DIV.CZ - FILMY, SERI√ÅLY, KNIHY, HRY
        const KNOWLEDGE_BASE = {
            articles: [
                {
                    title: "Nejlep≈°√≠ filmy roku 2024",
                    perex: "P≈ôehled nejlep≈°√≠ch film≈Ø, kter√© vy≈°ly v roce 2024 - od akƒçn√≠ch blockbuster≈Ø po indie dramata.",
                    url: "https://div.cz/filmy-2024"
                },
                {
                    title: "Seri√°lov√© novinky na streamovac√≠ch platform√°ch",
                    perex: "Co nov√©ho na Netflixu, HBO Max, Disney+ a dal≈°√≠ch streamovac√≠ch slu≈æb√°ch tento mƒõs√≠c.",
                    url: "https://div.cz/serialy-streaming"
                },
                {
                    title: "Knihy, kter√© mus√≠te p≈ôeƒç√≠st",
                    perex: "V√Ωbƒõr nejlep≈°√≠ch knih souƒçasnosti - od thriller≈Ø po sci-fi a fantasy.",
                    url: "https://div.cz/knihy-doporuceni"
                },
                {
                    title: "Hern√≠ recenze a novinky",
                    perex: "Nejnovƒõj≈°√≠ recenze videoher, trailery a zpr√°vy ze svƒõta gaming industry.",
                    url: "https://div.cz/herni-novinky"
                },
                {
                    title: "Marvel vs DC: Kdo vede v roce 2024",
                    perex: "Srovn√°n√≠ filmov√Ωch vesm√≠r≈Ø Marvel a DC a jejich pl√°n≈Ø na nadch√°zej√≠c√≠ roky.",
                    url: "https://div.cz/marvel-vs-dc"
                }
            ],
            glossary: [
                {
                    term: "Streaming",
                    definition: "Zp≈Øsob distribuce audiovizu√°ln√≠ho obsahu p≈ôes internet v re√°ln√©m ƒçase, nap≈ô. Netflix, HBO Max, Disney+."
                },
                {
                    term: "Blockbuster",
                    definition: "Komerƒçnƒõ velmi √∫spƒõ≈°n√Ω film s vysok√Ωm rozpoƒçtem, kter√Ω p≈ôit√°hne velk√© mno≈æstv√≠ div√°k≈Ø."
                },
                {
                    term: "Indie film",
                    definition: "Nez√°visl√Ω film produkovan√Ω mimo hlavn√≠ filmov√° studia, ƒçasto s umƒõleck√Ωm zamƒõ≈ôen√≠m."
                },
                {
                    term: "Open World",
                    definition: "Hern√≠ ≈æ√°nr, kde m≈Ø≈æe hr√°ƒç volnƒõ prozkoum√°vat rozs√°hl√Ω hern√≠ svƒõt."
                }
            ],
            categories: [
                {
                    title: "Filmy",
                    use_cases: "Recenze film≈Ø, trailery, rozhovory s herci, filmov√© novinky a doporuƒçen√≠."
                },
                {
                    title: "Seri√°ly",
                    use_cases: "Seri√°lov√© recenze, sez√≥nn√≠ p≈ôehledy, epizodn√≠ guide, streamovac√≠ tipy."
                },
                {
                    title: "Knihy",
                    use_cases: "Kni≈æn√≠ recenze, rozhovory s autory, ≈æ√°nrov√© p≈ôehledy, liter√°rn√≠ novinky."
                },
                {
                    title: "Hry",
                    use_cases: "Hern√≠ recenze, gameplay videa, novinky ze svƒõta gaming, esport ud√°losti."
                }
            ]
        };

        // FUNKCE PRO SAMOUƒåEN√ç
        function loadLearnedData() {
            try {
                const saved = localStorage.getItem('div_chat_learned_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data && data.interactions) {
                        return data;
                    }
                }
            } catch (e) {
                console.warn('Could not load learned data:', e);
            }
            
            return {
                interactions: [],
                successful_responses: [],
                common_questions: [],
                last_updated: new Date().toISOString()
            };
        }

        function saveLearnedData(data) {
            try {
                if (data.interactions.length > 1000) {
                    data.interactions = data.interactions.slice(-1000);
                }
                
                data.last_updated = new Date().toISOString();
                localStorage.setItem('div_chat_learned_data', JSON.stringify(data));
            } catch (e) {
                console.warn('Could not save learned data:', e);
            }
        }

        function saveInteractionForLearning(question, answer, context) {
            const badAnswerSubstrings = [
                "API endpoint nebyl nalezen", "Omlouv√°m se, moment√°lnƒõ nemohu odpovƒõdƒõt", "Chyba:",
                "nen√≠ nastaven", "neplatn√Ω form√°t", "Doƒçasnƒõ nedostupn√©",
                "na tento dotaz nemohu odpovƒõdƒõt", "zat√≠m nezn√°m odpovƒõƒè", "nen√≠ spr√°vnƒõ nakonfigurov√°n"
            ];
            
            if (!answer || answer.trim() === '') {
                console.log("Skipping learning: Answer is empty.");
                return;
            }
            
            for (const substring of badAnswerSubstrings) {
                if (answer.includes(substring)) {
                    console.log("Skipping learning: Answer contains bad substring");
                    return;
                }
            }
            
            if (answer.trim().length < 20) {
                console.log("Skipping learning: Answer is too short");
                return;
            }

            const learnedData = loadLearnedData();
            const interaction = {
                question: question,
                answer: answer,
                context_used: context,
                timestamp: Date.now(),
                usage_count: 1
            };  
            
            let similarFound = false;
            for (const existing of learnedData.interactions) {
                const similarity = calculateQuestionSimilarity(question, existing.question || '');
                if (similarity > 0.7) {
                    existing.usage_count++;
                    existing.last_used = Date.now();
                    similarFound = true;
                    break;
                }
            }
            
            if (!similarFound) {
                learnedData.interactions.push(interaction);
            }
            
            updateCommonQuestions(learnedData, question);
            saveLearnedData(learnedData);
        }

        function getLearnedResponse(question, learnedData) {
            if (!learnedData.interactions || learnedData.interactions.length === 0) {
                return null;
            }
            
            let bestMatch = null;
            let bestScore = 0;
            
            for (const interaction of learnedData.interactions) {
                const similarity = calculateQuestionSimilarity(question, interaction.question || '');
                const score = similarity * (1 + Math.log(1 + (interaction.usage_count || 1)));
                
                if (score > bestScore && score > 0.6) {
                    bestScore = score;
                    bestMatch = interaction.answer || '';
                }
            }
            
            return bestMatch;
        }

        function calculateQuestionSimilarity(q1, q2) {
            if (!q1 || !q2) return 0;
            
            q1 = q1.toLowerCase();
            q2 = q2.toLowerCase();
            
            const words1 = [...new Set(q1.split(' '))];
            const words2 = [...new Set(q2.split(' '))];
            
            const commonWords = words1.filter(word => words2.includes(word));
            const totalWords = words1.length + words2.length;
            
            if (totalWords === 0) return 0;
            
            return (2 * commonWords.length) / totalWords;
        }

        function updateCommonQuestions(learnedData, newQuestion) {
            let found = false;
            
            for (const item of learnedData.common_questions) {
                if (calculateQuestionSimilarity(item.question || '', newQuestion) > 0.8) {
                    item.frequency++;
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                learnedData.common_questions.push({
                    question: newQuestion,
                    frequency: 1,
                    first_seen: Date.now()
                });
            }
            
            learnedData.common_questions.sort((a, b) => (b.frequency || 0) - (a.frequency || 0));
            learnedData.common_questions = learnedData.common_questions.slice(0, 20);
        }

        // POMOCN√â FUNKCE
        function buildKnowledgeBase(articles, glossary, categories, relevantContext = "", learnedData = []) {
            let context = "Zde jsou informace o DIV.cz (filmy, seri√°ly, knihy, hry), ze kter√Ωch m≈Ø≈æe≈° ƒçerpat:\n\n";
            
            if (relevantContext) {
                context += "== NEJRELEVANTNƒöJ≈†√ç OBSAH ==\n" + relevantContext + "\n";
            }
            
            if (learnedData.interactions && learnedData.interactions.length > 0) {
                context += "== NAUƒåEN√â ODPOVƒöDI Z P≈òEDCHOZ√çCH KONVERZAC√ç ==\n";
                const recentInteractions = learnedData.interactions.slice(-5);
                for (const interaction of recentInteractions) {
                    context += "OT√ÅZKA: " + (interaction.question || '') + "\n";
                    context += "ODPOVƒöƒé: " + (interaction.answer || '') + "\n\n";
                }
            }
            
            context += "== ƒåL√ÅNKY ==\n";
            for (const item of articles.slice(0, 10)) { 
                context += "N√°zev: " + (item.title || '') + "\nObsah: " + (item.perex || '') + "\nURL: " + (item.url || '') + "\n\n"; 
            }
            
            context += "== SLOVN√çK POJM≈Æ ==\n";
            for (const item of glossary.slice(0, 15)) { 
                context += "Pojem: " + (item.term || '') + "\nDefinice: " + (item.definition || '') + "\n\n"; 
            }
            
            context += "== KATEGORIE ==\n";
            for (const item of categories) { 
                context += "Kategorie: " + (item.title || '') + "\nPopis: " + (item.use_cases || '') + "\n\n"; 
            }
            
            return context;
        }

        function findRelevantContext(userMessage, articles, glossary, categories) {
            const keywords = extractKeywords(userMessage);
            if (keywords.length === 0) return "";
            
            let relevantContent = "";
            
            for (const article of articles) {
                const relevance = calculateRelevance(article, keywords);
                if (relevance > 0.2) {
                    relevantContent += "ƒåL√ÅNEK: " + (article.title || '') + "\n" + 
                                      "OBSAH: " + (article.perex || '') + "\n" +
                                      "URL: " + (article.url || '') + "\n\n";
                }
            }
            
            for (const item of glossary) {
                const relevance = calculateRelevance(item, keywords, 'term');
                if (relevance > 0.3) {
                    relevantContent += "POJEM: " + (item.term || '') + "\n" +
                                      "DEFINICE: " + (item.definition || '') + "\n\n";
                }
            }
            
            for (const item of categories) {
                const relevance = calculateRelevance(item, keywords);
                if (relevance > 0.2) {
                    relevantContent += "KATEGORIE: " + (item.title || '') + "\n" +
                                      "POPIS: " + (item.use_cases || '') + "\n\n";
                }
            }
            
            return relevantContent;
        }

        function extractKeywords(text) {
            if (!text) return [];
            
            const stopwords = ['a', 'aby', 'ale', 'asi', 'az', 'bez', 'bude', 'by', 'byt', 'ci', 'co', 'cz', 'dalsi', 'dnes', 'do', 'ho', 'i', 'jako', 'je', 'jeho', 'jeji', 'jejich', 'jen', 'jen≈æ', 'ji', 'jine', 'jiz', 'k', 'kam', 'kde', 'kdo', 'kdy', 'kdyz', 'ke', 'ktera', 'kter√©', 'kteri', 'kter√°', 'kter√Ω', 'ku', 'ma', 'mate', 'me', 'melo', 'mi', 'mit', 'mne', 'mnƒõ', 'muj', 'muze', 'my', 'na', 'nad', 'nam', 'napiste', 'nas', 'na≈°e', 'ne', 'nebo', 'necht', 'nejsou', 'neni', 'nez', 'n√≠', 'nov√©', 'o', 'od', 'on', 'pak', 'po', 'pod', 'podle', 'pouze', 'prave', 'pro', 'proc', 'proto', 'protoze', 'prvni', 'pta', 'p≈ôi', 're', 's', 'se', 'si', 'sice', 'spoleƒçnosti', 'svych', 'sv√©', 'ta', 'tak', 'take', 'taky', 'te', 'tedy', 'tema', 'teprve', 'ti', 'to', 'tohle', 'toho', 'tohoto', 'tom', 'tomto', 'tomu', 'toto', 'tu', 'tuto', 'tv≈Øj', 'ty', 'tyto', 'u', 'u≈æ', 'v', 'vam', 'vas', 'vase', 've', 'vedle', 'vice', 'vsak', 'v√°m', 'v√°s', 'z', 'za', 'zda', 'zde', 'ze', 'zpet', 'zpravy', 'i'];
            
            const words = text.toLowerCase().split(/\s+/);
            const keywords = words.filter(word => 
                word.length > 2 && 
                !stopwords.includes(word) && 
                /^[a-≈æ]+$/u.test(word)
            );
            
            return [...new Set(keywords)];
        }

        function calculateRelevance(item, keywords, field = 'title') {
            if (keywords.length === 0) return 0;
            
            let text = '';
            if (field === 'title') {
                text = ((item.title || '') + ' ' + (item.perex || '') + ' ' + (item.use_cases || '') + ' ' + (item.definition || '')).toLowerCase();
            } else {
                text = (item[field] || '').toLowerCase();
            }
            
            let score = 0;
            for (const keyword of keywords) {
                if (text.includes(keyword)) {
                    score += 1;
                    if ((item.title || '').toLowerCase().includes(keyword)) {
                        score += 2;
                    }
                }
            }
            
            return score / keywords.length;
        }

        // HLAVN√ç FUNKCE
        function detectUserIntent(message) {
            const messageLower = message.toLowerCase();

            const intents = {
                'greeting': ['ahoj', 'dobr√Ω den', 'ƒçau', 'zdrav√≠m', 'cus', 'nazdar', 'hello', 'hi', 'dobr√© r√°no', 'dobr√Ω veƒçer'],
                'farewell': ['dƒõkuji', 'd√≠ky', 'na shledanou', 'mƒõj se', 'bye', 'konec', 'dƒõkuji za pomoc', 'papa'],
                'help': ['co um√≠≈°', 'pomoc', 'n√°povƒõda', 'funkce', 'pom≈Ø≈æe≈°', 'co dok√°≈æe≈°', 'pomoc s'],
                'movie_question': ['film', 'filmy', 'kino', 'doporuƒç film', 'recenze film', 'trailer', 'herec', 'hereƒçka', 're≈æis√©r'],
                'series_question': ['seri√°l', 'seri√°ly', 'd√≠l', 'epizoda', 'sez√≥na', 'netflix', 'hbo', 'disney', 'streamov√°n√≠'],
                'book_question': ['kniha', 'knihy', 'ƒçten√≠', 'autor', 'spisovatel', 'rom√°n', 'pov√≠dka', 'literatura'],
                'gaming_question': ['hra', 'hry', 'gaming', 'videohra', 'recenze hry', 'playstation', 'xbox', 'nintendo', 'pc hra'],
                'recommendation': ['doporuƒç', 'doporuƒçen√≠', 'co si pustit', 'co ƒç√≠st', 'co hr√°t', 'tip na'],
                'article_search': ['ƒçl√°nek', 'blog', 'n√°vod', 'tutorial', 'p≈ô√≠ruƒçka', 'dokumentace', 'naj√≠t ƒçl√°nek', 'hledat ƒçl√°nek'],
                'technical_question': ['jak funguje', 'co je', 'vysvƒõtli', 'definice', 'v√Ωznam', 'popis', 'jak na to'],
                'complaint': ['probl√©m', 'chyba', 'nefunguje', '≈°patnƒõ', 'nespokojen', 'selhalo', 'nejde', 'nefunguje'],
                'delete_data': ['vyma≈æ', 'sma≈æ', 'zapome≈à', 'reset', 'delete', 'vyma≈æte moji konverzaci', 'vymazat konverzaci']
            };

            for (const [intent, keywords] of Object.entries(intents)) {
                for (const keyword of keywords) {
                    if (messageLower.includes(keyword)) {
                        return intent;
                    }
                }
            }

            return 'general_query';
        }

        function analyzeSentiment(message) {
            if (!message) return 'neutral';

            const positiveWords = [
                'skvƒõl√Ω', 'super', 'dƒõkuji', 'pomohlo', 'v√Ωbornƒõ', 'dobr√Ω', 'perfektn√≠',
                '√∫≈æasn√Ω', 'd√≠ky', 'pƒõkn√©', 'vynikaj√≠c√≠', 'spokojen', 'r√°d', 'b√°jeƒçn√Ω', 'skvƒõle'
            ];
            const negativeWords = [
                'probl√©m', 'chyba', '≈°patnƒõ', 'nefunguje', 'nespokojen', '≈°patn√Ω',
                'hloup√Ω', '≈°patn√©', '≈°patn√°', 'ne', '≈°patnƒõ', 'katastrofa', 'hrozn√Ω', 'ot≈ôesn√Ω'
            ];
            const positivePatterns = [
                /dƒõkuji(\s+.*)?/ui, /jsem\s+spokojen/ui, /pomohl(o|a)/ui, /v√Ωbornƒõ/ui, /skvƒõl√©/ui
            ];
            const negativePatterns = [
                /nefunguje/ui, /probl√©m/ui, /nespokojen/ui, /chyba/ui, /katastrofa/ui, /nejde/ui
            ];

            let positiveCount = 0;
            let negativeCount = 0;

            const words = message.toLowerCase().split(' ');
            for (const word of words) {
                const cleanWord = word.replace(/[^\w]/u, '');
                if (positiveWords.includes(cleanWord)) positiveCount++;
                if (negativeWords.includes(cleanWord)) negativeCount++;
            }

            for (const pattern of positivePatterns) {
                if (pattern.test(message)) positiveCount += 2;
            }
            for (const pattern of negativePatterns) {
                if (pattern.test(message)) negativeCount += 2;
            }

            if (positiveCount > negativeCount + 1) return 'positive';
            if (negativeCount > positiveCount + 1) return 'negative';
            return 'neutral';
        }

        function detectLanguage(message) {
            if(!message || message.trim() === '') return 'cs';
            
            const englishIndicators = ['what', 'how', 'why', 'who', 'where', 'when', 'is', 'are', 'am', 'do', 'does', 'did', 'you', 'i', 'me', 'my', 'your', 'please', 'help', 'product', 'price', 'hello', 'hi', 'hey', 'thank', 'goodbye', 'contact', 'about', 'service', 'feature', 'can', 'could', 'should', 'would', 'the', 'a', 'in', 'on', 'at', 'it', 'for', 'with'];
            const messageLower = message.trim().toLowerCase();

            if (/^[a-zA-Z0-9\s\p{P}]*$/u.test(message)) {
                let containsIndicator = false;
                for (const indicator of englishIndicators) {
                    if (new RegExp('\\b' + indicator + '\\b', 'i').test(messageLower)) {
                        containsIndicator = true;
                        break;
                    }
                }
                if (containsIndicator) return 'en';
            }

            if (/[^\x00-\x7F]/.test(message)) {
                return 'cs';
            }

            const words = messageLower.match(/\b[a-zA-Z]{2,}\b/g) || [];
            if (words.length > 0) {
                const wordCount = words.length;
                let englishCount = 0;
                for (const word of words) {
                    if (englishIndicators.includes(word)) englishCount++;
                }
                if (wordCount > 0 && (englishCount / wordCount > 0.10 || (wordCount <= 6 && englishCount > 0))) return 'en';
            }

            if (/^\s*(hi|hello|hey|how are|what is|can you|i need|tell me)\b/i.test(message)) return 'en';

            return 'cs';
        }

        function generateSmartSuggestions(context, conversation) {
            let suggestions = [];

            switch (context.user_intent) {
                case 'movie_question':
                    suggestions = ["Nejlep≈°√≠ filmy 2024", "Akƒçn√≠ filmy", "Komedie", "Horory"];
                    break;
                case 'series_question':
                    suggestions = ["Nov√© na Netflixu", "HBO seri√°ly", "ƒåesk√© seri√°ly", "Animovan√© seri√°ly"];
                    break;
                case 'book_question':
                    suggestions = ["Nejprod√°vanƒõj≈°√≠ knihy", "Fantasy", "Thrillery", "ƒåesk√° literatura"];
                    break;
                case 'gaming_question':
                    suggestions = ["Nejhranƒõj≈°√≠ hry", "PS5 novinky", "Xbox hry", "PC hry"];
                    break;
                case 'recommendation':
                    suggestions = ["Doporuƒç film", "Doporuƒç seri√°l", "Doporuƒç knihu", "Doporuƒç hru"];
                    break;
                default:
                    suggestions = ["Doporuƒç film", "Nov√© seri√°ly", "Hern√≠ novinky", "Co ƒç√≠st"];
            }

            if (context.conversation_depth > 3) {
                suggestions.push("Pot≈ôebuji lidskou podporu");
                suggestions.push("Hledat na webu");
            }

            return suggestions.slice(0, 3);
        }

        async function getSmartAnswer(question, context, history, image = null, sentiment = 'neutral', userIntent = 'general', language = 'cs') {
            if (!CONFIG.API_KEY) {
                console.error("CHYBA: API kl√≠ƒç nen√≠ nastaven!");
                return "Omlouv√°m se, moment√°lnƒõ nemohu odpovƒõdƒõt. Administr√°tor mus√≠ nastavit API kl√≠ƒç.";
            }

            if (!CONFIG.API_KEY.startsWith("sk-ant-")) {
                console.error("CHYBA: Neplatn√Ω form√°t API kl√≠ƒçe");
                return "Chyba: Nebyl zad√°n platn√Ω API kl√≠ƒç pro Claude.";
            }

            let historyString = "";
            for (const entry of history) {
                const role = (entry.role === 'user') ? "U≈æivatel" : "Asistent";
                historyString += role + ": " + entry.text + "\n";
            }

            const tone = (sentiment === 'positive') ? "p≈ô√°telsk√Ω a nad≈°en√Ω" : 
                        (sentiment === 'negative') ? "empatick√Ω a ch√°pav√Ω" : "neutr√°ln√≠";

            let lengthRequirement = "";
            const lengthMatch = question.match(/(\d+)\s*(znak|znaky|znak≈Ø|character|characters)/i);
            if (lengthMatch) {
                const requestedLength = parseInt(lengthMatch[1]);
                lengthRequirement = `**KRITICK√â: U≈æivatel po≈æaduje odpovƒõƒè p≈ôesnƒõ v ${requestedLength} znac√≠ch. Toto je NEJVY≈†≈†√ç priorita!**\n`;
            }

            const prompt = `Jsi AI asistent pro web DIV.cz (filmy, seri√°ly, knihy, hry, z√°bava).\n\n` +
                          `KONTEXT KONVERZACE:\n` +
                          `- N√°lada u≈æivatele: ${sentiment} (pou≈æij ${tone} t√≥n)\n` +
                          `- Z√°mƒõr u≈æivatele: ${userIntent}\n` +
                          `- Hloubka konverzace: ${history.length} zpr√°v\n` +
                          `- Zamƒõ≈ôen√≠: filmy, seri√°ly, knihy, hry, z√°bava\n\n` +

                          lengthRequirement +

                          `PRAVIDLA ODPOV√çD√ÅN√ç:\n` +
                          `0. **ABSOLUTNƒö KRITICK√â: Odpovƒõz POUZE v jazyce '${language}'. Nikdy nep≈ôekl√°dej do jin√©ho jazyka.\n` +
                          `1. POKUD ZPR√ÅVA OBSAHUJE V√çCE OT√ÅZEK, ODPOVƒöZ NA V≈†ECHNY (m≈Ø≈æe≈° pou≈æ√≠t odr√°≈æky nebo ƒç√≠slovan√Ω seznam).\n` +
                          `2. Odpov√≠dej STRUƒåNƒö (maxim√°lnƒõ 2-3 vƒõty, v√Ωjimeƒçnƒõ 4 pro slo≈æit√° vysvƒõtlen√≠), POKUD nen√≠ specificky po≈æadov√°no jinak.\n` +
                          `3. Pou≈æij poskytnut√Ω kontext z webu DIV.cz pro relevantn√≠ odpovƒõdi\n` +
                          `4. Pokud odpovƒõƒè vych√°z√≠ z ƒçl√°nku nebo u≈æivatel ≈æ√°d√° odkaz, V≈ΩDY p≈ôidej klikateln√Ω odkaz ve form√°tu: 'V√≠ce: [N√°zev](URL)' nebo 'ƒål√°nek: [Zde](https://div.cz/clanek)'\n` +
                          `5. Pro doporuƒçen√≠ film≈Ø/seri√°l≈Ø/knih/her pou≈æ√≠vej konkr√©tn√≠ p≈ô√≠klady\n` +
                          `6. Pokud nev√≠≈°, radƒõji p≈ôiznej neznalost ne≈æ h√°dej\n` +
                          `7. U negativn√≠ho sentimentu buƒè obzvl√°≈°≈• empatick√Ω\n` +
                          `8. M≈Ø≈æe≈° se inspirovat nauƒçen√Ωmi odpovƒõƒèmi z p≈ôedchoz√≠ch konverzac√≠\n\n` +

                          `HISTORIE KONVERZACE:\n` + historyString + `\n` +
                          `KONTEXT Z WEBU DIV.CZ:\n--- KONTEXT ---\n` + context + `--- KONEC KONTEXTU ---\n\n` +
                          `AKTU√ÅLN√ç OT√ÅZKA U≈ΩIVATELE:\n` + question + `\n\n` +
                          `Tvoje odpovƒõƒè (**POVINNƒö v jazyce '${language}'**):`;

            const content = [
                {
                    type: "text",
                    text: prompt
                }
            ];

            if (image) {
                content.unshift({
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: "image/jpeg",
                        data: image
                    }
                });
            }

            const postData = {
                model: CONFIG.MODEL,
                max_tokens: CONFIG.MAX_TOKENS,
                messages: [
                    {
                        role: "user",
                        content: content
                    }
                ]
            };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CONFIG.API_KEY,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(postData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    
                    if (response.status === 401) {
                        return language === 'en' ? "Authentication error. Please contact the administrator." : "Chyba ovƒõ≈ôen√≠. Kontaktujte administr√°tora.";
                    }
                    if (response.status === 404) {
                        return language === 'en' ? "API service not found. Please try again later." : "API slu≈æba nebyla nalezena. Zkuste to pros√≠m pozdƒõji.";
                    }
                    if (response.status === 429) {
                        return language === 'en' ? "Rate limit exceeded. Please try again in a moment." : "P≈ôekroƒçen limit po≈æadavk≈Ø. Zkuste to za chv√≠li.";
                    }
                    if (response.status >= 500) {
                        return language === 'en' ? "AI service temporarily unavailable. Please try again later." : "Slu≈æba AI doƒçasnƒõ nedostupn√°. Zkuste to pros√≠m pozdƒõji.";
                    }
                    
                    return language === 'en' 
                        ? `Temporary service issue (Error: ${response.status}). Please try again.`
                        : `Doƒçasn√Ω probl√©m se slu≈æbou (Chyba: ${response.status}). Zkuste to pros√≠m znovu.`;
                }

                const data = await response.json();
                
                if (data.content && data.content[0] && data.content[0].text) {
                    return data.content[0].text;
                } else {
                    console.error('Unexpected API response structure:', data);
                    return "Omlouv√°m se, na tento dotaz nemohu odpovƒõdƒõt (neƒçekan√° struktura odpovƒõdi).";
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('Request timeout');
                    return language === 'en' 
                        ? "Request timeout. Please try again with a simpler question."
                        : "ƒåasov√Ω limit po≈æadavku. Zkuste to pros√≠m znovu s jednodu≈°≈°√≠ ot√°zkou.";
                }
                
                console.error('Network error:', error);
                return language === 'en'
                    ? "Sorry, there was an error connecting to the AI service. Please try again."
                    : "Omlouv√°m se, do≈°lo k chybƒõ p≈ôipojen√≠ k AI slu≈æbƒõ. Zkuste to pros√≠m znovu.";
            }
        }

        // UI FUNKCE
        function useSuggestion(element) {
            const text = element.textContent;
            userInput.value = text;
            sendMessage();
        }

        // Initialize chat
        function initChat() {
            loadConversation();
            if (conversation.length === 0) {
                showSuggestions(["Doporuƒç film", "Nov√© seri√°ly", "Hern√≠ novinky", "Co ƒç√≠st"]);
            }

            resetInactivityTimer();
        }

        // Detekce neƒçinnosti a reset konverzace
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (conversation.length > 2) {
                    const message = "Vid√≠m, ≈æe jste p≈ôestal/a ps√°t. Pokud pot≈ôebujete dal≈°√≠ pomoc, staƒç√≠ napsat!";
                    addBotMessage(message, ["Doporuƒç film", "Nov√© seri√°ly", "Hern√≠ novinky"]);
                }
            }, 300000); // 5 minut neƒçinnosti
        }

        // Send message on button click
        sendBtn.addEventListener('click', sendMessage);

        // Send message on Enter key (but allow Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            resetInactivityTimer();
        });

        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            resetInactivityTimer();
        });

        // Voice recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            try {
                recognition = new SpeechRecognition();
                recognition.lang = 'cs-CZ';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    isRecording = false;
                    voiceBtn.classList.remove('active');
                    resetInactivityTimer();
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    voiceBtn.classList.remove('active');

                    if (event.error === 'not-allowed') {
                        alert('Povolte p≈ô√≠stup k mikrofonu v nastaven√≠ prohl√≠≈æeƒçe.');
                    } else if (event.error === 'no-speech') {
                        alert('Nebyla zaznamen√° ≈æ√°dn√° ≈ôeƒç. Zkuste to znovu.');
                    } else if (event.error === 'network') {
                        alert('Probl√©m se s√≠t√≠. Zkontrolujte p≈ôipojen√≠ k internetu.');
                    }
                };

                recognition.onend = () => {
                    isRecording = false;
                    voiceBtn.classList.remove('active');
                };
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                voiceBtn.style.display = 'none';
            }
        } else {
            voiceBtn.style.display = 'none';
        }

        voiceBtn.addEventListener('click', () => {
            if (!recognition) {
                alert('V√°≈° prohl√≠≈æeƒç nepodporuje hlasov√© ovl√°d√°n√≠.');
                return;
            }

            if (isRecording) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('Error stopping recognition:', error);
                }
                isRecording = false;
                voiceBtn.classList.remove('active');
            } else {
                try {
                    recognition.start();
                    isRecording = true;
                    voiceBtn.classList.add('active');
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    alert('Nepoda≈ôilo se spustit hlasov√© ovl√°d√°n√≠. Zkuste to pros√≠m znovu.');
                    isRecording = false;
                    voiceBtn.classList.remove('active');
                }
            }
            resetInactivityTimer();
        });

        // Image upload
        imageBtn.addEventListener('click', () => {
            imageUpload.click();
            resetInactivityTimer();
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

                if (!allowedTypes.includes(file.type)) {
                    alert('Nepodporovan√Ω form√°t obr√°zku. Povolen√© form√°ty: JPG, PNG, GIF, WebP');
                    return;
                }

                if (file.size > maxSize) {
                    alert('Obr√°zek je p≈ô√≠li≈° velk√Ω. Maxim√°ln√≠ velikost je 5MB.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        uploadedImage = event.target.result.split(',')[1];
                        imageBtn.classList.add('active');
                        if (userInput.value.trim() === '') {
                            userInput.value = 'Analyzuj tento obr√°zek';
                        }
                    } catch (error) {
                        console.error('Error processing image:', error);
                        alert('Chyba p≈ôi zpracov√°n√≠ obr√°zku. Zkuste jin√Ω soubor.');
                        uploadedImage = null;
                        imageBtn.classList.remove('active');
                    }
                };
                reader.onerror = () => {
                    alert('Chyba p≈ôi ƒçten√≠ souboru. Zkuste to pros√≠m znovu.');
                    uploadedImage = null;
                    imageBtn.classList.remove('active');
                };
                reader.readAsDataURL(file);
            }
            resetInactivityTimer();
        });

        // Text-to-speech
        speakerBtn.addEventListener('click', () => {
            if (!lastBotMessage) {
                alert('Zat√≠m nen√≠ ≈æ√°dn√° odpovƒõƒè k p≈ôeƒçten√≠.');
                return;
            }

            if ('speechSynthesis' in window) {
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    speakerBtn.classList.remove('active');
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(lastBotMessage);

                const isEnglish = /^[a-zA-Z0-9\s\p{P}]*$/u.test(lastBotMessage) &&
                                  /\b(the|is|are|what|how|can|you|your|this|that)\b/i.test(lastBotMessage);
                utterance.lang = isEnglish ? 'en-US' : 'cs-CZ';
                utterance.rate = 0.9;

                utterance.onstart = () => {
                    speakerBtn.classList.add('active');
                };
                utterance.onend = () => {
                    speakerBtn.classList.remove('active');
                };
                utterance.onerror = () => {
                    speakerBtn.classList.remove('active');
                    window.speechSynthesis.cancel();
                };

                window.speechSynthesis.speak(utterance);
            } else {
                alert('V√°≈° prohl√≠≈æeƒç nepodporuje text-to-speech.');
            }
            resetInactivityTimer();
        });

        // Message handling
        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (messageText === '' && !uploadedImage) return;

            addUserMessage(messageText || "[Obr√°zek nahr√°n]");
            userInput.value = '';
            userInput.style.height = 'auto';
            clearSuggestions();
            showTypingIndicator();

            const historyForApi = conversation.slice(-4).map(msg => ({
                role: msg.role,
                text: msg.text
            }));

            // Z√≠sk√°n√≠ nauƒçen√Ωch dat
            const learnedData = loadLearnedData();
            
            // Detekce z√°mƒõru a sentimentu
            const userIntent = detectUserIntent(messageText);
            const sentiment = analyzeSentiment(messageText);
            const language = detectLanguage(messageText);
            
            // Sestaven√≠ kontextu
            const relevantContext = findRelevantContext(messageText, KNOWLEDGE_BASE.articles, KNOWLEDGE_BASE.glossary, KNOWLEDGE_BASE.categories);
            const knowledgeBase = buildKnowledgeBase(KNOWLEDGE_BASE.articles, KNOWLEDGE_BASE.glossary, KNOWLEDGE_BASE.categories, relevantContext, learnedData);

            // Nejprve zkusit nauƒçenou odpovƒõƒè
            let reply = getLearnedResponse(messageText, learnedData);
            let usedLearnedData = false;

            if (reply) {
                usedLearnedData = true;
                reply = reply + "\n\n*(Odpovƒõƒè zalo≈æen√° na p≈ôedchoz√≠ch interakc√≠ch)*";
                hideTypingIndicator();
                lastBotMessage = reply.replace(/<br>/g, "\n").replace(/<\/?[^>]+(>|$)/g, "");
                addBotMessage(reply, generateSmartSuggestions({user_intent: userIntent, conversation_depth: conversation.length}, conversation));
            } else {
                // Pokud nen√≠ nauƒçen√° odpovƒõƒè, zavolat AI
                try {
                    console.log('Sending request to AI...');
                    reply = await getSmartAnswer(messageText, knowledgeBase, historyForApi, uploadedImage, sentiment, userIntent, language);
                    
                    hideTypingIndicator();
                    
                    // Ulo≈æit interakci pro uƒçen√≠
                    saveInteractionForLearning(messageText, reply, relevantContext);
                    
                    lastBotMessage = reply.replace(/<br>/g, "\n").replace(/<\/?[^>]+(>|$)/g, "");
                    addBotMessage(reply, generateSmartSuggestions({user_intent: userIntent, conversation_depth: conversation.length}, conversation));
                } catch (error) {
                    console.error('Error sending/receiving message:', error);
                    hideTypingIndicator();
                    addBotMessage('Omlouv√°m se, nastala chyba p≈ôi komunikaci se serverem. Zkuste to pros√≠m znovu.', []);
                }
            }

            // Resetovat nahran√Ω obr√°zek
            uploadedImage = null;
            imageBtn.classList.remove('active');
            imageUpload.value = '';

            resetInactivityTimer();
        }

        function addUserMessage(text, save = true) {
            if (save) {
                conversation.push({ role: 'user', text: text });
                saveConversation();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;

            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addBotMessage(text, suggestions, save = true) {
            if (save) {
                conversation.push({
                    role: 'bot',
                    text: text,
                    suggestions: suggestions
                });
                saveConversation();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            let processedText = text.replace(/\n/g, '<br>');
            processedText = processedText.replace(
                /\[(.*?)\]\((.*?)\)/g,
                '<a href="$2" target="_blank" style="color: #007aff; text-decoration: none;">$1</a>'
            );

            if (text.includes('*(Odpovƒõƒè zalo≈æen√° na p≈ôedchoz√≠ch interakc√≠ch)*')) {
                 processedText = processedText.replace('*(Odpovƒõƒè zalo≈æen√° na p≈ôedchoz√≠ch interakc√≠ch)*', '');
                 processedText += '<div class="learned-badge">üß† Nauƒçeno z p≈ôedchoz√≠ch konverzac√≠</div>';
            }

            bubble.innerHTML = processedText;
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);

            showSuggestions(suggestions);
            scrollToBottom();
        }

        function showSuggestions(suggestions) {
            clearSuggestions();
            if (!suggestions || suggestions.length === 0) return;

            suggestions.forEach(text => {
                const chip = document.createElement('button');
                chip.className = 'suggestion-chip';
                chip.textContent = text;
                chip.onclick = () => useSuggestion(chip);
                suggestionsContainer.appendChild(chip);
            });
        }

        function clearSuggestions() {
            suggestionsContainer.innerHTML = '';
        }

        function showTypingIndicator() {
            if (document.getElementById('typing-indicator')) return;

            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'message bot-message';

            const bubble = document.createElement('div');
            bubble.className = 'typing-indicator';
            bubble.innerHTML = `
                <div>üé¨ AI asistent p≈ôem√Ω≈°l√≠<span class="typing-dots"></span></div>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
            `;

            indicator.appendChild(bubble);
            chatMessages.appendChild(indicator);
            scrollToBottom();

            setTimeout(() => {
                const fill = bubble.querySelector('.progress-fill');
                if (fill) {
                    fill.style.width = '30%';
                    setTimeout(() => {
                        fill.style.width = '70%';
                    }, 500);
                }
            }, 100);
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function saveConversation() {
            try {
                sessionStorage.setItem('chatConversation', JSON.stringify(conversation));
            } catch (e) {
                console.warn('Could not save conversation to sessionStorage:', e);
            }
        }

        function loadConversation() {
            try {
                const saved = sessionStorage.getItem('chatConversation');
                if (saved) {
                    conversation = JSON.parse(saved);
                    chatMessages.innerHTML = '';

                    conversation.forEach(msg => {
                        if (msg.role === 'user') {
                            addUserMessage(msg.text, false);
                        } else {
                            addBotMessage(msg.text, msg.suggestions || [], false);
                        }
                    });

                    const lastBotMsg = conversation[conversation.length - 1];
                    if (lastBotMsg && lastBotMsg.role === 'bot') {
                        lastBotMessage = lastBotMsg.text.replace(/<br>/g, "\n").replace(/<\/?[^>]+(>|$)/g, "");
                        if (lastBotMsg.suggestions) {
                            showSuggestions(lastBotMsg.suggestions);
                        }
                    }
                }
            } catch (e) {
                console.warn('Could not load conversation from sessionStorage:', e);
                conversation = [];
            }
        }

        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', initChat);
    </script>
</body>
</html>